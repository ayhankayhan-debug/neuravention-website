name: Supabase DB Backup (pg_dump)

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Why are you taking this backup?"
        required: false
        default: "pre-live snapshot"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install PostgreSQL client (pg_dump)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Resolve Supabase DB hostname to IPv4 (avoid IPv6)
        env:
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail
          HOST="db.${PROJECT_REF}.supabase.co"

          # Get IPv4 only
          IPV4="$(getent ahostsv4 "$HOST" | awk '{print $1; exit}')"

          if [ -z "$IPV4" ]; then
            echo "Could not resolve IPv4 for $HOST"
            getent ahosts "$HOST" || true
            exit 1
          fi

          echo "SUPABASE_DB_HOST_IPV4=$IPV4" >> "$GITHUB_ENV"
          echo "Resolved $HOST -> $IPV4"

      - name: Create Supabase dump (custom format)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
          DB_HOST_IPV4: ${{ env.SUPABASE_DB_HOST_IPV4 }}
        run: |
          set -euo pipefail

          TS="$(date -u +'%Y-%m-%d_%H-%M-%S')"
          OUT="supabase_backup_${TS}.dump"
          echo "OUT_FILE=$OUT" >> "$GITHUB_ENV"

          pg_dump \
            -h "$DB_HOST_IPV4" \
            -p 5432 \
            -U postgres \
            -d postgres \
            -F c \
            --no-owner \
            --no-acl \
            -f "$OUT"

          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-db-backup
          path: ${{ env.OUT_FILE }}
          retention-days: 7
