name: backup

on:
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Prepare pg_dump (Postgres 17 via Docker)
        run: |
          set -euo pipefail
          docker --version
          docker run --rm postgres:17 pg_dump --version

      - name: Preflight (confirm pooler host + IPv4)
        env:
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          POOLER_HOST: ${{ secrets.SUPABASE_POOLER_HOST }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail

          if [ -z "${PROJECT_REF}" ]; then echo "ERROR: missing SUPABASE_PROJECT_REF"; exit 1; fi
          if [ -z "${POOLER_HOST}" ]; then echo "ERROR: missing SUPABASE_POOLER_HOST"; exit 1; fi
          if [ -z "${PGPASSWORD}" ]; then echo "ERROR: missing SUPABASE_DB_PASSWORD"; exit 1; fi

          # POOLER_HOST sadece hostname olmalı (port/path yok)
          if echo "$POOLER_HOST" | grep -Eq '[:/]'; then
            echo "ERROR: SUPABASE_POOLER_HOST must be hostname only (no :port or /path). Current: $POOLER_HOST"
            exit 1
          fi

          echo "✅ Using pooler host: $POOLER_HOST"
          echo "✅ Resolving IPv4:"
          getent ahostsv4 "$POOLER_HOST" | head -n 5 || true

      - name: Create Supabase dump (custom format) via Session Pooler (5432)
        env:
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          POOLER_HOST: ${{ secrets.SUPABASE_POOLER_HOST }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
          PGCONNECT_TIMEOUT: "20"
        run: |
          set -euo pipefail

          TS="$(date -u +'%Y-%m-%d_%H-%M-%S')"
          OUT="supabase_backup_${TS}.dump"
          echo "OUT_FILE=$OUT" >> "$GITHUB_ENV"

          # Supavisor Session mode user format
          PGUSER="postgres.${PROJECT_REF}"

          echo "✅ pg_dump target => host=$POOLER_HOST port=5432 user=$PGUSER db=postgres"

          docker run --rm \
            -e PGPASSWORD="$PGPASSWORD" \
            -e PGSSLMODE="$PGSSLMODE" \
            -e PGCONNECT_TIMEOUT="$PGCONNECT_TIMEOUT" \
            -v "$PWD:/work" \
            -w /work \
            postgres:17 \
            pg_dump \
              -h "$POOLER_HOST" \
              -p 5432 \
              -U "$PGUSER" \
              -d postgres \
              -F c \
              --no-owner \
              --no-acl \
              -f "$OUT"

          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-db-backup
          path: ${{ env.OUT_FILE }}
          retention-days: 7
