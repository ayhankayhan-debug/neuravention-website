name: Supabase DB Backup (pg_dump via Supavisor Session Pooler)

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Why are you taking this backup?"
        required: false
        default: "pre-live snapshot"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install PostgreSQL client (pg_dump)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create Supabase dump (custom format) using Session Pooler
        env:
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          POOLER_HOST: ${{ secrets.SUPABASE_POOLER_HOST }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail

          TS="$(date -u +'%Y-%m-%d_%H-%M-%S')"
          OUT="supabase_backup_${TS}.dump"
          echo "OUT_FILE=$OUT" >> "$GITHUB_ENV"

          # Supavisor Session mode: port 5432, user is postgres.<project_ref>
          PGUSER="postgres.${PROJECT_REF}"

          pg_dump \
            -h "$POOLER_HOST" \
            -p 5432 \
            -U "$PGUSER" \
            -d postgres \
            -F c \
            --no-owner \
            --no-acl \
            -f "$OUT"

          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-db-backup
          path: ${{ env.OUT_FILE }}
          retention-days: 7
