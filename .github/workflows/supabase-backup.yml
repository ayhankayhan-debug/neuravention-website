name: Supabase DB Backup (pg_dump)

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Why are you taking this backup?"
        required: false
        default: "pre-live snapshot"

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL client (pg_dump)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create Supabase dump (custom format)
        env:
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail

          TS="$(date -u +'%Y-%m-%d_%H-%M-%S')"
          OUT="supabase_backup_${TS}.dump"

          echo "OUT_FILE=$OUT" >> "$GITHUB_ENV"

          pg_dump \
            -h "db.${PROJECT_REF}.supabase.co" \
            -p 5432 \
            -U postgres \
            -d postgres \
            -F c \
            --no-owner \
            --no-acl \
            -f "$OUT"

          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-db-backup
          path: ${{ env.OUT_FILE }}
          retention-days: 7
